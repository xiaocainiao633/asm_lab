# 汇编语言实验报告

## 实验名称

**基于 MASM32 的 Windows 贪吃蛇游戏设计与实现**

---

## 一、实验目的

1. 熟悉 **32 位以上汇编语言（MASM32）** 在 Windows 平台下的程序开发流程
2. 掌握 **Windows API** 在汇编语言中的调用方法（窗口、消息、绘图、键盘输入等）
3. 理解并实现 **模块化程序设计思想**
4. 通过游戏项目，提高对 **状态机、数据结构、实时逻辑控制** 的理解
5. 在基础功能之上实现扩展功能，提高程序的完整性与创新性

---

## 二、实验环境

- 操作系统：Windows 10 / Windows 11
- 开发工具：MASM32 SDK
- 汇编器：ml.exe
- 链接器：link.exe
- 调试工具：OllyDbg / Visual Studio（辅助）
- 程序类型：32 位 Windows GUI 程序

---

## 三、总体设计方案

### 3.1 程序整体结构

程序采用 **模块化设计**，主要划分如下：

```
SnakeGame.asm
│
├── WinMain / 主窗口模块
├── 消息处理模块（WndProc）
├── 游戏初始化模块
├── 游戏逻辑模块
│   ├── 蛇移动
│   ├── 碰撞检测
│   ├── 吃食物
│   └── 游戏结束判断
├── 绘图显示模块
├── 键盘输入处理模块
└── 扩展功能模块
```

---

## 四、界面与布局设计

### 4.1 游戏窗口布局

采用 **Windows API 绘图（GDI）**，窗口结构如下：

```
+--------------------------------+
|  贪吃蛇游戏                    |
|--------------------------------|
|                                |
|   ■ ■ ■                        |
|   ■ ○                          |
|   ■                            |
|                                |
|--------------------------------|
| 分数：  速度：                 |
+--------------------------------+
```

- 游戏区域：固定大小的网格（如 20×20）
- 蛇身体：矩形块
- 食物：不同颜色的方块
- 状态信息：分数、速度、暂停状态等

---

## 五、核心数据结构设计

### 5.1 蛇的数据结构

```asm
SnakeX DWORD MAX_LEN DUP(?)
SnakeY DWORD MAX_LEN DUP(?)
SnakeLen DWORD ?
Direction DWORD ?
```

含义说明：

| 变量名          | 含义               |
| --------------- | ------------------ |
| SnakeX / SnakeY | 存储蛇每一节的位置 |
| SnakeLen        | 当前蛇长度         |
| Direction       | 当前移动方向       |

### 5.2 食物结构

```asm
FoodX DWORD ?
FoodY DWORD ?
```

---

## 六、基础功能实现

### 6.1 游戏初始化 ✅

- ✅ 创建窗口
- ✅ 初始化蛇的位置（居中）
- ✅ 初始化方向（向右）
- ✅ 随机生成食物位置
- ✅ 设置定时器（`SetTimer`）

---

### 6.2 键盘控制 ✅

使用 `WM_KEYDOWN` 消息处理方向键：

| 按键 | 方向 |
| ---- | ---- |
| ↑    | 上   |
| ↓    | 下   |
| ←    | 左   |
| →    | 右   |

> ✅ 防止蛇反向移动（如正在向右时禁止直接向左）

---

### 6.3 蛇的移动算法（核心逻辑）✅

**思路：尾随移动**

```text
从尾部开始，每一节等于前一节的位置
蛇头根据方向改变坐标
```

伪逻辑：

```
for i = len-1 → 1
    Snake[i] = Snake[i-1]

根据 Direction 更新 Snake[0]
```

---

### 6.4 吃食物逻辑 ✅

判断：

```
如果 SnakeHead == Food
```

则：

- ✅ 蛇长度 +1
- ✅ 分数增加
- ✅ 重新生成食物

---

### 6.5 碰撞检测 ✅

#### 1️⃣ 撞墙检测 ✅

```text
SnakeX < 0 or > MaxX
SnakeY < 0 or > MaxY
```

#### 2️⃣ 撞自身检测 ✅

```text
SnakeHead == SnakeBody[i]
```

→ 游戏结束

---

### 6.6 绘图显示 ✅

使用 GDI API：

- ✅ `Rectangle`
- ✅ `FillRect`
- ✅ `CreateSolidBrush`

绘制内容：

- ✅ 背景
- ✅ 蛇身体
- ✅ 食物
- ✅ 文本信息（分数）

---

## 七、扩展功能设计（加分重点 ⭐）

### 7.1 多速度等级（推荐）✅

- ✅ 随蛇长度增加，自动加快速度
- ✅ 动态修改 `SetTimer` 时间

```text
长度越长 → Timer 越小 → 蛇越快
```

---

### 7.2 暂停 / 继续功能 ✅

- ✅ 按 `Space` 键暂停
- ✅ 停止 Timer
- ✅ 再次按下恢复

---

### 7.3 关卡或障碍物系统

- 固定障碍方块
- 蛇撞障碍直接结束
- 可设计不同关卡布局

---

### 7.4 最高分记录（非常加分）✅

- ✅ 使用文件操作 API
- ✅ 保存历史最高分
- ✅ 程序启动时读取

---

### 7.5 彩色蛇 / 动态效果 ✅

- ✅ 蛇头不同颜色
- ✅ 吃食物闪烁效果
- ✅ 简单动画感

---

## 八、程序性能与优化

1. 使用定时器而非忙等待，**CPU 占用低**
2. 数组方式存储蛇身，访问效率高
3. 模块划分明确，便于维护和拓展
4. 避免重复绘制，减少闪烁

---

## 九、实验难点与解决方法

### 难点 1：实时游戏循环

- **解决方法**：使用 `SetTimer + WM_TIMER` 实现稳定刷新

### 难点 2：汇编实现复杂逻辑

- **解决方法**：先用伪代码设计逻辑，再翻译成汇编

### 难点 3：图形绘制管理

- **解决方法**：统一在 `WM_PAINT` 中绘制，逻辑与显示分离

---
